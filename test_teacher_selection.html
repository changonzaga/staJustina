<!DOCTYPE html>
<html>
<head>
    <title>Department Teacher Search Test</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .search-results-container { position: relative; }
        .search-results-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; z-index: 1000; max-height: 200px; overflow-y: auto; }
        .teacher-search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .teacher-search-item:hover { background-color: #f0f0f0; }
        .teacher-name { font-weight: bold; }
        .teacher-details { font-size: 0.9em; color: #666; }
        .debug-info { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Department Teacher Search Test</h1>
    
    <div class="test-section">
        <h2>Test 1: AJAX Search Endpoint</h2>
        <input type="text" id="ajaxSearchInput" placeholder="Search teachers via AJAX..." style="width: 300px; padding: 10px;">
        <div id="ajaxResults"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Complete Teacher Selection Workflow</h2>
        <form id="testForm">
            <div style="margin: 10px 0;">
                <label>Department Name:</label>
                <input type="text" name="department_name" value="Test Department" style="width: 200px; padding: 5px;">
            </div>
            
            <div style="margin: 10px 0;">
                <label>Head Selection (AJAX Search):</label>
                <div class="search-results-container">
                    <input type="text" id="teacher-search-input" placeholder="Type teacher's name to search..." autocomplete="off" style="width: 300px; padding: 10px;">
                    <div id="teacher-search-results" class="search-results-list" style="display: none;">
                        <div id="teacher-search-list"></div>
                    </div>
                </div>
                
                <select id="dept_head_id" name="head_id" style="width: 300px; padding: 10px; margin-top: 10px;">
                    <option value="">-- Select Head --</option>
                </select>
                
                <div id="selected-teacher-display" style="display: none; margin-top: 10px;">
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 4px;">
                        <strong>Selected:</strong> <span id="selected-teacher-name"></span>
                        <button type="button" onclick="clearSelectedTeacher()" style="margin-left: 10px;">Clear</button>
                    </div>
                </div>
            </div>
            
            <button type="submit" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px;">Test Submit</button>
        </form>
        
        <div id="formDebug" class="debug-info" style="display: none;">
            <h3>Form Debug Info:</h3>
            <div id="formDebugContent"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Debug Functions</h2>
        <button onclick="testAjaxEndpoint()">Test AJAX Endpoint</button>
        <button onclick="debugDropdown('#dept_head_id')">Debug Dropdown</button>
        <button onclick="checkFormData()">Check Form Data</button>
        <div id="debugOutput"></div>
    </div>

    <script>
        // AJAX Teacher Search Functionality
        function setupAjaxTeacherSearch() {
            console.log('Setting up AJAX teacher search...');
            
            let searchTimeout;
            
            function performTeacherSearch(searchTerm, resultsContainer, searchList) {
                if (searchTerm.length < 2) {
                    resultsContainer.hide();
                    return;
                }
                
                searchList.html('<div style="padding: 10px;">Searching teachers...</div>');
                resultsContainer.show();
                
                $.ajax({
                    url: 'http://localhost:8080/admin/department/teachers',
                    method: 'GET',
                    data: { search: searchTerm },
                    dataType: 'json',
                    success: function(response) {
                        console.log('Search response:', response);
                        if (response.results && response.results.length > 0) {
                            let html = '';
                            response.results.forEach(function(teacher) {
                                html += `
                                    <div class="teacher-search-item" data-id="${teacher.id}" data-text="${teacher.text}">
                                        <div class="teacher-name">${teacher.full_name}</div>
                                        <div class="teacher-details">${teacher.position} - ${teacher.status}</div>
                                    </div>
                                `;
                            });
                            searchList.html(html);
                            
                            // Add click handlers for search results
                            searchList.find('.teacher-search-item').on('click', function() {
                                const teacherId = $(this).data('id');
                                const teacherText = $(this).data('text');
                                const teacherName = $(this).find('.teacher-name').text();
                                
                                console.log('Teacher selected:', { teacherId, teacherText, teacherName });
                                
                                // Update dropdown selection
                                const $select = $('#dept_head_id');
                                $select.val(teacherId);
                                $select.trigger('change');
                                
                                // Update search input
                                $('#teacher-search-input').val(teacherName);
                                
                                // Show selected teacher display
                                $('#selected-teacher-name').text(teacherText);
                                $('#selected-teacher-display').show();
                                
                                // Hide search results
                                resultsContainer.hide();
                                
                                // Verify the selection
                                console.log('Dropdown value after selection:', $select.val());
                                console.log('Teacher selection completed');
                            });
                        } else {
                            searchList.html('<div style="padding: 10px;">No teachers found</div>');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Search error:', error);
                        searchList.html('<div style="padding: 10px; color: red;">Error searching teachers</div>');
                    }
                });
            }
            
            $('#teacher-search-input').on('input', function() {
                const searchTerm = $(this).val();
                const resultsContainer = $('#teacher-search-results');
                const searchList = $('#teacher-search-list');
                
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    performTeacherSearch(searchTerm, resultsContainer, searchList);
                }, 300);
            });
        }
        
        function clearSelectedTeacher() {
            $('#dept_head_id').val('').trigger('change');
            $('#teacher-search-input').val('');
            $('#selected-teacher-display').hide();
            $('#teacher-search-results').hide();
        }
        
        function testAjaxEndpoint() {
            $.ajax({
                url: 'http://localhost:8080/admin/department/teachers',
                method: 'GET',
                data: { search: 'test' },
                dataType: 'json',
                success: function(response) {
                    $('#debugOutput').html('<div class="success">✅ AJAX Endpoint Working! Found ' + (response.results ? response.results.length : 0) + ' teachers</div>');
                    console.log('AJAX Test Response:', response);
                },
                error: function(xhr, status, error) {
                    $('#debugOutput').html('<div class="error">❌ AJAX Endpoint Error: ' + error + '</div>');
                    console.error('AJAX Test Error:', error);
                }
            });
        }
        
        function debugDropdown(selectId) {
            const $select = $(selectId);
            const debugInfo = `
                <div class="debug-info">
                    <strong>Dropdown Debug Info:</strong><br>
                    - Element: ${selectId}<br>
                    - Value: ${$select.val()}<br>
                    - Options count: ${$select.find('option').length}<br>
                    - Selected option text: "${$select.find('option:selected').text()}"<br>
                    - Select2 initialized: ${$select.hasClass('select2-hidden-accessible')}
                </div>
            `;
            $('#debugOutput').html(debugInfo);
        }
        
        function checkFormData() {
            const formData = new FormData(document.getElementById('testForm'));
            let output = '<div class="debug-info"><strong>Form Data:</strong><br>';
            for (let [key, value] of formData.entries()) {
                output += `${key}: ${value}<br>`;
            }
            output += '</div>';
            $('#debugOutput').html(output);
        }
        
        // Form submission handler
        $('#testForm').on('submit', function(e) {
            e.preventDefault();
            const headId = $('#dept_head_id').val();
            console.log('Form submission - head_id value:', headId);
            
            let debugContent = `
                <strong>Form Submission Debug:</strong><br>
                Department Name: ${$('input[name="department_name"]').val()}<br>
                Head ID: ${headId || 'NULL'}<br>
                Head Name: ${$('#dept_head_id option:selected').text()}<br>
            `;
            
            if (headId && headId !== '') {
                debugContent += '<div class="success">✅ Head ID will be submitted: ' + headId + '</div>';
            } else {
                debugContent += '<div class="error">⚠️ No Head ID selected - will submit as NULL</div>';
            }
            
            $('#formDebugContent').html(debugContent);
            $('#formDebug').show();
        });
        
        // Initialize when document is ready
        $(document).ready(function() {
            console.log('Test page loaded');
            setupAjaxTeacherSearch();
            
            // Test AJAX endpoint on load
            testAjaxEndpoint();
        });
    </script>
</body>
</html>

